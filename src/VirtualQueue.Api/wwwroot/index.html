<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Queue - Real-time Demo</title>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .queue-info { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .user-info { background: #e8f4fd; padding: 10px; margin: 5px 0; border-radius: 3px; }
        .priority-vip { background: #ffd700; }
        .priority-high { background: #ff6b6b; }
        .priority-normal { background: #e8f4fd; }
        .status-waiting { color: #ff6b6b; }
        .status-released { color: #51cf66; }
        .status-dropped { color: #868e96; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Virtual Queue - Real-time Demo</h1>
        
        <div class="queue-info">
            <h3>Connection Status</h3>
            <p id="connectionStatus">Disconnected</p>
            <button id="connectBtn" class="btn-primary">Connect</button>
            <button id="disconnectBtn" class="btn-danger">Disconnect</button>
        </div>

        <div class="queue-info">
            <h3>Queue Management</h3>
            <input type="text" id="tenantId" placeholder="Tenant ID" value="4c09e9ce-cbeb-4cec-b9d3-205f65dc0701">
            <input type="text" id="queueId" placeholder="Queue ID" value="d6d8bb53-acd0-49aa-b1e3-6db17d02f23c">
            <button id="joinQueueBtn" class="btn-primary">Join Queue</button>
            <button id="leaveQueueBtn" class="btn-danger">Leave Queue</button>
        </div>

        <div class="queue-info">
            <h3>User Management</h3>
            <input type="text" id="userIdentifier" placeholder="User Identifier" value="demo-user-001">
            <select id="priority">
                <option value="0">Normal</option>
                <option value="1">High</option>
                <option value="2">VIP</option>
                <option value="3">Premium</option>
            </select>
            <button id="enqueueBtn" class="btn-success">Enqueue User</button>
            <button id="subscribeUserBtn" class="btn-primary">Subscribe to User</button>
        </div>

        <div class="queue-info">
            <h3>Real-time Updates</h3>
            <div id="updates"></div>
        </div>

        <div class="queue-info">
            <h3>Queue Statistics</h3>
            <div id="statistics"></div>
        </div>
    </div>

    <script>
        let connection = null;
        let isConnected = false;

        const connectionStatus = document.getElementById('connectionStatus');
        const updatesDiv = document.getElementById('updates');
        const statisticsDiv = document.getElementById('statistics');

        // Connection buttons
        document.getElementById('connectBtn').addEventListener('click', connect);
        document.getElementById('disconnectBtn').addEventListener('click', disconnect);

        // Queue buttons
        document.getElementById('joinQueueBtn').addEventListener('click', joinQueue);
        document.getElementById('leaveQueueBtn').addEventListener('click', leaveQueue);

        // User buttons
        document.getElementById('enqueueBtn').addEventListener('click', enqueueUser);
        document.getElementById('subscribeUserBtn').addEventListener('click', subscribeToUser);

        function connect() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/queuehub")
                .build();

            connection.start().then(() => {
                isConnected = true;
                connectionStatus.textContent = "Connected";
                connectionStatus.style.color = "green";
                addUpdate("‚úÖ Connected to SignalR hub");
            }).catch(err => {
                addUpdate("‚ùå Connection failed: " + err.toString());
            });

            // Event handlers
            connection.on("JoinedQueue", (queueId) => {
                addUpdate(`üéØ Joined queue: ${queueId}`);
            });

            connection.on("LeftQueue", (queueId) => {
                addUpdate(`üëã Left queue: ${queueId}`);
            });

            connection.on("SubscribedToUser", (userIdentifier) => {
                addUpdate(`üë§ Subscribed to user: ${userIdentifier}`);
            });

            connection.on("QueueUpdated", (data) => {
                addUpdate(`üîÑ Queue updated: ${JSON.stringify(data)}`);
            });

            connection.on("UserUpdated", (data) => {
                addUpdate(`üë§ User updated: ${JSON.stringify(data)}`);
            });

            connection.on("PositionUpdated", (data) => {
                addUpdate(`üìç Position updated: User ${data.userIdentifier} is at position ${data.position}`);
            });

            connection.on("UserReleased", (data) => {
                addUpdate(`üéâ User released: ${data.userIdentifier} at ${data.releasedAt}`);
            });

            connection.on("QueueStatistics", (data) => {
                statisticsDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            });

            connection.on("Error", (message) => {
                addUpdate(`‚ùå Error: ${message}`);
            });
        }

        function disconnect() {
            if (connection) {
                connection.stop().then(() => {
                    isConnected = false;
                    connectionStatus.textContent = "Disconnected";
                    connectionStatus.style.color = "red";
                    addUpdate("üîå Disconnected from SignalR hub");
                });
            }
        }

        function joinQueue() {
            if (!isConnected) {
                addUpdate("‚ùå Not connected to hub");
                return;
            }

            const queueId = document.getElementById('queueId').value;
            connection.invoke("JoinQueueGroup", queueId);
        }

        function leaveQueue() {
            if (!isConnected) {
                addUpdate("‚ùå Not connected to hub");
                return;
            }

            const queueId = document.getElementById('queueId').value;
            connection.invoke("LeaveQueueGroup", queueId);
        }

        function subscribeToUser() {
            if (!isConnected) {
                addUpdate("‚ùå Not connected to hub");
                return;
            }

            const userIdentifier = document.getElementById('userIdentifier').value;
            connection.invoke("SubscribeToUserUpdates", userIdentifier);
        }

        async function enqueueUser() {
            const tenantId = document.getElementById('tenantId').value;
            const queueId = document.getElementById('queueId').value;
            const userIdentifier = document.getElementById('userIdentifier').value;
            const priority = parseInt(document.getElementById('priority').value);

            try {
                const response = await fetch(`/api/v1/tenants/${tenantId}/queues/${queueId}/usersessions/enqueue`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userIdentifier: userIdentifier,
                        metadata: `Demo user with priority ${priority}`,
                        priority: priority
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    addUpdate(`‚úÖ User enqueued: ${JSON.stringify(result)}`);
                } else {
                    const error = await response.text();
                    addUpdate(`‚ùå Enqueue failed: ${error}`);
                }
            } catch (error) {
                addUpdate(`‚ùå Enqueue error: ${error.message}`);
            }
        }

        function addUpdate(message) {
            const timestamp = new Date().toLocaleTimeString();
            const updateElement = document.createElement('div');
            updateElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            updateElement.style.margin = '5px 0';
            updateElement.style.padding = '5px';
            updateElement.style.backgroundColor = '#f8f9fa';
            updateElement.style.borderRadius = '3px';
            updatesDiv.insertBefore(updateElement, updatesDiv.firstChild);
        }
    </script>
</body>
</html>
